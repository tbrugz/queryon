<!DOCTYPE html>
<html>
<head>
	<title>QueryOn - workspace</title>
	<link href="css/queryon.css" rel="stylesheet">
	<link href="css/qon-components.css" rel="stylesheet">
	<link href="css/qon-editor.css" rel="stylesheet">
	<link rel="icon" type="image/png" href="favicon.png" />
	<script src="js/qon-base.js"></script>
	<script src="js/qon-util.js"></script>
	<script src="js/auth.js"></script>
	<script src="js/models.js"></script>
	<script src="js/settings.js"></script>
	<script src="js/http-post.js"></script>
	<script src="js/table.js"></script>
	<script src="js/ui.js"></script>
	<script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/editor.js"></script>
<style>
#logo {
	margin: 2px;
	margin-left: 4px;
}
#queryResult {
	font-family: monospace;
}
#queryResultControls input {
	position: fixed;
	background-color: #bbb;
	z-index: 10;
}
.message {
	white-space: pre;
	min-height: 22px;
	font-family: monospace;
}
#authinfo {
	float: right;
	margin-top: 4px;
}
.closebutton {
	/*float: right;
	top: 2px;*/
	display: inline-block;
	vertical-align: top;
}
.labelBtn {
	border: 1px solid #999;
	padding: 3px 9px 3px 9px;
	background-color: #999;
}
.labelBtn input[type=number] {
	width: 4em;
}
</style>
<script type="text/javascript">

var responseType = "htmlx";
var queryOnUrl = 'q';

var editor = null;
var pageAltered = false;

function onLoad() {
	loadAce();
	updateUI();
	loadAuthInfo();
	loadModels();
	loadSettings(loadSettingsCallback);
	registerKeybindings();
}

function loadAuthInfoCallback() { onLoadAfter(); }

function loadModelsContentCallback() {
	//if(modelsInfo.length>1) {
	//	byId('model').parentNode.style.display = 'inline-block';
	//}
	onLoadAfter();
}

function loadSettingsCallback() {
	//console.log("loadSettingsCallback", settings);
	if(settings["queryon.web.login.show"]=="false") {
		byId('authinfo').style.display='none';
	}
}

function onLoadAfter() {
	if(! authInfo.loaded) return;
	//if(! settings['queryon.project.version']) return;
	if(! modelsInfo) return;
	
	var modelId = getParameterByName('model', location.search);
	
	if(modelsInfo!=null) {
		if(modelsInfo.indexOf(modelId)<0 && isMultiModel()) {
			console.warn("model not found: ",modelId," models:",modelsInfo);
			showErrorMessages("messages", "model not found: <b>"+modelId+"</b> [models: "+modelsInfo+"]");
		}
		if(modelsInfo.length>1) {
			byId('modelLabel').style.display = 'inline-block';
			byId('model').parentNode.style.display = 'inline-block';
			if(! modelId) {
				modelId = modelsInfo[0];
			}
			byId('model').value = modelId;
		}
	}
	refreshAuthInfo();
}

function updateUI() {
	byId('resultContainer').style.top = (byId('controls').offsetHeight) + 'px';
	if(editor) { editor.resize(); }
}

function loadAce() {
	//console.log('loadAce...');
	
	editor = ace.edit("editor");
	editor.$blockScrolling = true;
	editor.setTheme("ace/theme/twilight"); //monokai,ambiance,twilight,,eclipse,github ?
	editor.getSession().setMode("ace/mode/sql"); //javascript, html, json, markdown, css, xml
	editor.setOptions({
		fontSize: "11pt"
	});
	editor.getSession().on('change', onTextFieldChange);
	editor.getSelectedText = function() {
		return this.getSession().getTextRange(this.getSelectionRange());
	};
	// http://stackoverflow.com/questions/27534263/making-ace-editor-resizable
	// https://github.com/ajaxorg/ace/wiki/Configuring-Ace
	editor.setAutoScrollEditorIntoView(true);
	//editor.onclick = updateUI;
	byId('editor').onclick = function() {
		//console.log('editor.onclick'); 
		updateUI();
	};
}

function onTextFieldChange() {
	pageAltered = true;
	removeMarker(editor);
}

function doValidate() {
	var url = queryOnUrl+"/ValidateAny";
	doRequest(url, 'btnValidate', false, doValidateCallback);
}

function doValidateCallback(request) {
	var paramCount = 0;
	if(request.status >= 200 && request.status < 300) {
		paramCount = request.getResponseHeader('X-Validate-ParameterCount');
	}
	if(! request.responseText) {
		showInfoMessages("messages", "Statement successfully validated");
	}
	console.log('#params = '+paramCount);
	//var container = document.getElementById('sqlparams');
	setParameters(paramCount);
	updateUI();
}

function doExplain() {
	var url = queryOnUrl+"/ExplainAny";
	doRequest(url, 'btnExplain');
}

function doRun() {
	var url = queryOnUrl+"/SqlAny."+responseType;
	doRequest(url, 'btnRun');
}

function doDownload(ext) {
	var url = queryOnUrl+"/SqlAny."+ext;
	doRequest(url, 'btnDownload', true);
}

function doRequest(url, btnId, download, callback) {
	closeMessages("messages");
	removeMarker(editor);
	if(!download) {
		closeResults();
	}
	
	var sqlString = editor.getSelectedText();
	if(!sqlString) { sqlString = editor.getValue(); }
	//console.log("sqlString[", sqlString.length, "]", sqlString);
	if(!sqlString) {
		showErrorMessages("messages", "query cannot be null...");
		return;
	}
	var modelId = getCurrentModelId();
	
	// FormData seems to add CR to each linebreak...
	/* var reqData = new FormData();
	reqData.set("sql", sqlString);
	reqData.set("schema", "workspace-schema");
	reqData.set("name", "workspace-name");
	reqData.set("lostrategy", "RESULTSET_CONTROL"); */
	var reqData = {}
	reqData.sql = sqlString;
	reqData.schema = ""; //"workspace-schema";
	reqData.name = "workspace"; //"workspace-name";
	reqData.lostrategy = "RESULTSET_CONTROL";
	
	if(modelId) {
		//console.log("modelId", modelId);
		//reqData.set("model", modelId);
		reqData.model = modelId;
	}
	var updatemax = byId('updatemax').value;
	if(isInteger(updatemax)) {
		reqData.updatemax = updatemax;
	}
	
	var params = document.querySelectorAll('.parameter');
	//var paramsStr = '';
	console.log("modelId:", modelId, "params:", params);
	
	for (var i = 0; i < params.length; ++i) {
		var item = params[i];
		//console.log(item);
		//reqData.set(item.name, item.value);
		reqData[item.name] = item.value;
		//paramsStr += '/'+item.value;
	}
	
	var startTimeMilis = Date.now();
	
	var request = new XMLHttpRequest();
	request.open("POST", url, true);
	request.onload = function(oEvent) {
		var completedTimeMilis = Date.now();
		console.log('request.status: ', request.status); //, ' ; request: ', request,' ; oEvent: ', oEvent);
		if (request.status >= 200 && request.status < 300) {
			byId('resultContainer').style.display = 'block';
			//console.log("Ok", oEvent);
			var updateCount = request.getResponseHeader("X-UpdateCount");
			var warnings = request.getResponseHeader("X-Warning");
			if(updateCount) {
				var message = oEvent.target.responseText;
				//var message = updateCount+" rows updated"
				if(warnings) {
					message += " (<em>"+warnings+"</em>)";
					showWarnMessages("messages", message);
				}
				else {
					showInfoMessages("messages", message);
				}
			}
			else {
				if(download) {
					// https://stackoverflow.com/a/44435573/616413
					var contentType = this.getResponseHeader('Content-Type');
					var contentDisposition = this.getResponseHeader('Content-Disposition');
					// https://stackoverflow.com/a/23054920/
					//var fileName = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/)[1];
					var ext = url.substring(url.lastIndexOf(".")+1); // what if query has parameters? they should be POST parameters... no worries
					console.log("url:", url, "; ext: '", ext, "'; reqData.name:", reqData.name, "; Content-Type:", contentType, "; Content-Disposition:", contentDisposition);
					var fileName = reqData.name+"."+ext;
					saveBlob(oEvent.target.response, fileName, contentType);
				}
				else {
					byId('queryResult').innerHTML = oEvent.target.responseText;
				}
				//console.log("oEvent.target.responseText=",oEvent.target.responseText,"request");
				showRunStatusInfo('queryResult', 'status-container', startTimeMilis, completedTimeMilis);
			}
			
			if(warnings) {
				console.log("warnings: ", warnings);
			}
		}
		else {
			console.log("Err", oEvent);
			showErrorMessages("messages", oEvent.target.responseText
					+(request.status==403?" (invalid session?)":"")
					);
			checkForSqlWarnings(request, editor);
			closeMessages('status-container');
		}
		btnActionStop(btnId);
		if(callback) {
			callback(request);
		}
	}
	request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");	
	//request.overrideMimeType('text/html; charset=UTF-8');
	request.send(obj2encodedUrl(reqData));
	btnActionStart(btnId);
}

function setParameters(numparams) {
	var params = document.querySelectorAll('.parameter');
	console.log('numparams: '+numparams+' ; params.length: '+params.length);
	if(numparams > params.length) {
		var paramsStr = '';
		for(var i=params.length+1;i<=numparams;i++) {
			paramsStr += "<label class='parameter-label'>p"+i+": <input type='text' class='parameter' id='param"+i+"' name='p"+i+"'/></label>";
		}
		byId('sqlparams').innerHTML = paramsStr;
	}
	else if(numparams < params.length) {
		for (var i = params.length; i > numparams; --i) {
			var item = params[i-1];
			console.log(item);
			item = item.parentNode;
			item.parentNode.removeChild(item);
		}
	}
}

function showRunStatusInfo(containerId, messagesId, startTimeMilis, completedTimeMilis) {
	var content = document.getElementById(containerId);
	var messages = document.getElementById(messagesId);
	
	var numOfRows = content.getElementsByTagName('tr').length-1; // 1st is header
	var numOfCols = -1;
	if(numOfRows>0) {
		if(content.getElementsByTagName('tr')[0]) {
			numOfCols = content.getElementsByTagName('tr')[0].getElementsByTagName('th').length;
		}
		messages.innerHTML = 'rows = '+numOfRows
			+ ((numOfCols > 0) ? ' ; cols = ' + numOfCols : '')
			+' ; time = '+(completedTimeMilis-startTimeMilis)+'ms '
			+"<input type='button' class='statusbutton' onclick=\"javascript:closeMessages('"+messagesId+"')\" value='x' float='right'/>";
		messages.style.display = 'initial';
	}
	else {
		closeMessages(messagesId);
	}
}

// https://stackoverflow.com/questions/22724070/prompt-file-download-with-xmlhttprequest/44435573#44435573
function saveBlob(content, fileName, contentType) {
	var a = document.createElement('a');
	blob = new File([content], fileName); //, { type: contentType });
	a.href = window.URL.createObjectURL(blob);
	a.download = fileName;
	a.dispatchEvent(new MouseEvent('click'));
}

function closeResults() {
	byId('queryResult').innerHTML = '';
	byId('resultContainer').style.display = 'none';
}

/* see: index.html: downloadExtFilter (+html, +sql) */
var defaultDownloadExts = [ "csv", "htmlx", "json", "md", "sql", "xml" ];
var downloadExtFilter = [ "csv", "htmlx", "json", "md", "ods", "sql", "xls", "xlsx", "xml" ];

function getDownloadHrefs() {
	var ret = [];

	//var exts = settings["syntax.fileextensions"];
	var exts = defaultDownloadExts;
	//var exts = downloadExtFilter;
	//console.log("getDownloadHrefs... exts=", exts);
	for(var i=0;i<exts.length;i++) {
		if(downloadExtFilter.indexOf(exts[i])<0) { continue; }

		//var href = queryOnUrl+"/SqlAny."+exts[i]; //XXX modelId!
		ret.push({
			//"onclick": href,
			"onclick": "doDownload(\""+exts[i].trim()+"\");return false;",
			"label": exts[i],
			"title": "download "+exts[i]
		});
	}
	console.log("getDownloadHrefs...", exts, ret);
	
	return ret;
}

function registerKeybindings() {
	document.onkeydown = function(evt) {
		var evt = evt || window.event;
		var key = evt.keyCode; // evt.key
		var keyname = "";
		
		if(key == 27) { //esc
			closeDialogs();
			keyname = "ESC";
		}
		if(key==119) { //f8
			doValidate();
			keyname = "F8";
		}
		if(key==120) { //f9
			//console.log('document.onkeydown: F10?');
			//evt.stopPropagation();
			evt.preventDefault();
			doRun();
			keyname = "F9";
		}
		if(key==121) { //f10
		}
		
		if(keyname) {
			console.log('document.onkeydown: ',key,keyname);
		}
	}
}

function confirmExit(event) {
	if (pageAltered) {
		var dialogText = "Current page has been altered. Are you sure you want to close?";
		event.returnValue = dialogText;
		return dialogText;
	}
}

window.addEventListener("beforeunload", confirmExit);

window.onresize = updateUI;

</script>
</head>
<body onload="onLoad();" id="body">

<div id="controls">
<nav class="container">
	<span id="logo">Q<span style="color: #ff8a47;">On</span> <code>Workspace</code></span>

	<!-- <label style="display: none">
		<select id="model" onchange="onModelChanged(true);"></select>
	</label> -->
	<label id="modelLabel" style="display: none;">model: <input type="text" id="model" name="model" readonly="readonly" value=""/></label>
	
	<span id="authinfo">
		<span id="username"></span>
		<span id="authaction"></span>
	</span>
</nav>

<div id="editor"></div>

<div class="container">
	<div id="sqlparams">
	</div>
	
	<div id="button-container">
		<input type="button" id="btnValidate" value="validate" onclick="javascript:doValidate();" title="Validate SQL (F8)">
		<input type="button" id="btnExplain" value="explain" onclick="javascript:doExplain();" title="Explain SQL Plan">
		<label class="labelBtn" title="Max number of rows that may be updated/deleted by a DML command execution (DDL commands do not generate update-count)">max-updates: <input type="number" step="1" id="updatemax"> </label>
		<input type="button" id="btnRun" value="run" onclick="javascript:doRun();" title="Run SQL (F9)">
		<!--<input type="button" id="btnDownload0" value="download" onclick="javascript:doDownload('csv');" title="Download CSV" style="float: right;"/>-->
		<input type="button" id="btnDownload" value="download" onclick="createPopupBelow('download-ext', 'btnDownload', getDownloadHrefs());" title="Download (click to see avaiable formats)" style="float: right;"/>
	</div>
</div>

<div id="messages" class="message" style="display: none;"></div>
</div>

<div class="container" id="resultContainer" style="display: none;">
	<div id="queryResultControls"><input type='button' class='closebutton' onclick='closeResults()' value='X'/></div>
	<div id="queryResult"></div>
</div>

<div id="status-container" class="status">
</div>

</body>
