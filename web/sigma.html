<!DOCTYPE html>
<html>
<head>
	<title>QOn with sigma.js</title>
	<link href="css/queryon.css" rel="stylesheet">
	<link rel="icon" type="image/png" href="favicon.png" />
	<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
	<script src="js/queryon-b.js"></script>
	<script src="js/sigma/sigma.min.js"></script>
	<script src="js/sigma/plugins/sigma.layout.forceAtlas2.min.js"></script>
	<script src="js/sigma/plugins/sigma.plugins.dragNodes.min.js"></script>
<style type="text/css">
body {
	margin: 0;
}

#nav {
	background-color: #222;
	color: #ddd;
	font-weight: bold;
	font-size: 10pt;
	padding: 3px;
	position: fixed;
	top: 0px;
	right: 0px;
	left: 0px;
	/*height: 26px;*/
	z-index: 10;
	overflow-y: auto;
	max-height: 100%;
}

#logo {
	padding: 2px;
	font-size: 11pt;
	padding-left: 10px;
	padding-right: 10px;
	font-weight: bolder;
	background-color: #666;
}

#container {
	position: absolute;
	top: 41px;
	bottom: 10px;
	left: 10px;
	right: 10px;
	border: 1px solid #bbb;
	background-color: #bbb; /* #bbb, #eee */
}

#buttons {
	display: inline-block;
}

#dialog-container {
	position: fixed;
	top: 0; bottom: 0; left: 0; right: 0;
	background-color: #666;
	background-color: rgba(100,100,100,0.7);
	z-index: 20;
	display: none;
}
#dialog {
	position: fixed;
	top: 20%;
	left: 20%;
	background-color: #ccc;
	z-index: 20;
	padding: 10px;
	border: 4px solid #fff;
}
#dialog label {
	background-color: #ddd;
	padding: 5px;
}

</style>
</head>
<body onload="javascript:init('q','objects', writeOptions);">
<div id="nav" class="navbar">
	<span id="logo">Q<span style="color: #ff8a47">On</span> + sigma<span style="color: #ec5148">js</span></span>

	<select id="objects" onchange="onQueryChanged();"></select>
	
	<span id="navbar-prop">
		<span id="parameters"></span>
		<span id="filters"></span>
	</span>
	
	<div id="buttons">
		<input type="button" value="+ filter" onclick="addFilter();"/>
		<input type="button" class="mainaction" value="go!" onclick="loadGraph();"/>
		<input type="button" id="forcebutton" value="start force layout" onclick="toggleForce(s);"/>
		<!-- input type="button" value="stop layout" onclick="s.stopForceAtlas2();"/-->
	</div>
	
	<div id="messages"></div>
</div>

<div id="container"></div>

<div id="dialog-container">
	<div id="dialog">
	</div>
</div>

<script>
		function writeOptions(containerId, relations) {
			if(!relations) { return; }
			//console.log('write relations [#'+relations.length+'] to '+containerId);
			for(var i=0;i<relations.length;i++) {
				if(validGraphRelation(relations[i])) {
					var id = getId(relations[i]);
					$('#'+containerId).append("<option value='"+id+"'>"+getDescription(relations[i])+"</option>");
					relationsHash[id] = relations[i];
				}
			}
		}
		
		function onParameterChange(i) {}
		
		function validGraphRelation(relation) {
			var cols = getColumnsFromRelation(relation);
			if(cols.indexOf("SOURCE")>=0 && cols.indexOf("TARGET")>=0) {
				return true;
			}
			return false;
		}
		
		function onQueryChanged() {
			loadRelation('objects', 'parameters', 'content');
			//document.getElementById('navbar-prop').style.display = 'initial';
		}
		
		function updateUI() {
			document.getElementById('container').style.top = (document.getElementById('nav').offsetHeight+10) + 'px';
		}
		
		function addFilter() {
			var select = document.getElementById('objects');
			var id = select.options[select.selectedIndex].value;
			if(!id) {
				alert('no object selected!');
				return;
			}
			var dialogCont = document.getElementById('dialog-container');
			dialogCont.style.display = 'block';
			var dialog = document.getElementById('dialog');
			var cols = getColumnsFromRelation(relationsHash[id]);

			var selectHTML = "<select name='fin-column' id='fin-column'>";
			for(var i=0;i<cols.length;i++) {
				var colz = cols[i];
				selectHTML += "<option name='"+colz+"'>"+colz+"</option>";
			}
			selectHTML += '</select>';
			dialog.innerHTML = "<div><label>Filter: "+selectHTML+"</label> <em>in</em> "
				+ "<label>Value: <input type='text' name='value' id='fin-value'></label> "
				+ "<input type='button' value='add' onclick='addFilterIn();document.getElementById(\"dialog-container\").style.display = \"none\";'/>"
				+ "<input type='button' value='X' class='simplebutton' onclick='document.getElementById(\"dialog-container\").style.display = \"none\";'/></div>";
			//dialog.style.display = 'none';
			
			updateUI();
		}
		
		function addFilterIn() {
			var col = document.getElementById('fin-column').value;
			var value = document.getElementById('fin-value').value;
			var filters = document.getElementById('filters');
			filters.innerHTML += "<label class='filter-label'>"+col+" = <input type='text' class='filter' name='fin:"+col+"' value='"+value+"'/>"
				+ "<input type='button' value='X' class='simplebutton' onclick='this.parentNode.parentNode.removeChild(this.parentNode);'></label>";
			updateUI();
		}
		

		// ======================== sigma-related functions ========================
		
		// Let's first initialize sigma:
		sigma.renderers.def = sigma.renderers.canvas; //dragnodes needs this, i think
		var s = new sigma('container');
		var forceAtlasRunning = false;

		function contains(graph, id) {
			var nodes = graph.nodes();
			for(var i=0;i<nodes.length;i++) {
				if(nodes[i].id==id) {
					return true;
				}
			}
			return false;
		}
		
		function toggleForce(s) {
			var btn = document.getElementById('forcebutton');
			if(forceAtlasRunning) { //s.isForceAtlas2Running()) {
				s.stopForceAtlas2();
				btn.value = 'start force layout';
				forceAtlasRunning = false;
			}
			else {
				s.startForceAtlas2();
				btn.value = 'stop force layout';
				forceAtlasRunning = true;
			}
		}
		
		function getXorY() {
			return Math.random();
		}
		
		function addNode(graph, prefix, elem) {
			var id = elem[prefix];
			var label = elem[prefix+"_LABEL"]?elem[prefix+"_LABEL"]:elem[prefix];
			var color = elem[prefix+"_COLOR"]?elem[prefix+"_COLOR"]:'#fff';
			var ret = graph.addNode({
				id: id,
				label : label,
				// Display attributes:
				x: getXorY(),
				y: getXorY(),
				size : 1,
				color : color,
			});
			console.log("added node "+elem[prefix]);
		}
	
		function loadGraph() {
			var qid = document.getElementById('objects').options[document.getElementById('objects').selectedIndex].value;

			//parameters
			var params = document.querySelectorAll('.parameter');
			var paramsStr = '';
			for (var i = 0; i < params.length; ++i) {
				var item = params[i];
				var str = item.value;
				if(str=='') { str = '-'; } 
				paramsStr += '/'+str;
			}

			//filters
			var queryString = '';
			var filters = document.querySelectorAll('.filter');
			for (var i = 0; i < filters.length; ++i) {
				var item = filters[i];
				//console.log(item);
				queryString += '&'+item.name+"="+item.value;
			}

			// ajax
			var url = 'q/'+qid+paramsStr+'.json?'+queryString;
			console.log('url['+qid+']: '+url);
			var jqxhr = $.getJSON(url, function(data) {
				data = data[Object.keys(data)[0]];
				s.graph.clear();
				//console.log(data);
				//XXX: test if valid query (valid columns)
				for(var i=0;i<data.length;i++) {
					// maybe add source node
					if(!contains(s.graph,data[i].SOURCE)) {
						addNode(s.graph, "SOURCE", data[i]);
					}
					// maybe add target node
					if(!contains(s.graph,data[i].TARGET)) {
						addNode(s.graph, "TARGET", data[i]);
					}
					// add edge
					try {
						var eid = data[i].SOURCE+"$"+data[i].TARGET;
						s.graph.addEdge({
							id : eid,
							// Reference extremities:
							source : data[i].SOURCE,
							target : data[i].TARGET,
							type: 'arrow',
							//type : 'curve',
						});
						//console.log("added edge "+eid);
					}
					catch (e) {
						console.log(e+" / target: "+data[i].TARGET);
					}
				}
				// Finally, let's ask our sigma instance to refresh:
				s.refresh();
			})
			.fail(function() {
				showErrorMessages('messages', jqxhr.responseText);
			});
		}
		
		// see https://github.com/jacomyal/sigma.js/wiki/Settings#renderers-settings
		s.settings({
			edgeColor: 'default',
			defaultEdgeColor: 'grey',
			minNodeSize: 1,
			maxNodeSize: 4,
		});
		
		sigma.plugins.dragNodes(s, s.renderers[0]);
</script>

</body>
</html>

