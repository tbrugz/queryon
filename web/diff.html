<!DOCTYPE html>
<html>
<head>
	<title>QOn + diff</title>
	<link href="css/queryon.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" type="image/png" href="favicon.png" />
	<!-- link href="css/prism.css" rel="stylesheet" /-->
	<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
	<!-- script type="text/javascript" src="js/prism.js"></script-->
	<script src="js/qon-base.js"></script>
	<script src="js/qon-util.js"></script>
	<link rel="stylesheet" href="css/diffview.css">
	<script src="js/jsdifflib/difflib.js"></script>
	<script src="js/jsdifflib/diffview.js"></script>
	<script>
var queryOnUrl = 'qoi/';
var queryOnSchemaUrl = 'qos/';
var queryOnDiffUrl = 'qdiff/';
var queryOnDataDiffUrl = 'datadiff/';

/*
 * TODO: get object types by database type (info/objtypes.jsp ?)
 * XXX: show hourglass (?) icon on 'select's & DDL divs
 * XXX: clear way of showing if there are differences between objects (#lines added, changed, removed)
 * XXX: show model name above DDL div
 * XXX: option (xtra button) to show table's row count; compare tables' content
 */

var typemap = {
		"TABLE": "table",
		"FK": null, //"fk", //??
		"VIEW": "view",
		"INDEX": null,
		"EXECUTABLE": null,
		"TRIGGER": "trigger", //"executable", ??
		"SEQUENCE": "sequence",
		"SYNONYM": null,
		"GRANT": null,
		"MATERIALIZED_VIEW": "materialized_view", //"view",
		"FUNCTION": "function",
		"JAVA_SOURCE": null,
		"PACKAGE": "package",
		"PACKAGE_BODY": "package_body", //"executable",
		"PROCEDURE": "procedure",
		"TYPE": null, //"executable",
		"TYPE_BODY": null, //"executable",
		"CONSTRAINT": null,
		"COLUMN": null
};

var schemasByModel = {};

var defaultModelId = 'modelTo';

$(document).ready(
	function() {
		var tts = [];
		var keys = Object.keys(typemap);
		//console.log(keys.length);
		for(var i=0;i<keys.length;i++) {
			if(typemap[keys[i]]) { tts.push(keys[i]); }
		}
		loadSelect(tts, 'type');
	}
);

$.ajax({
	url: 'info/model.jsp',
	success: function(data) {
		var json = JSON.parse(data);
		//console.log(json);
		if(json.models) {
			loadSelect(json.models, 'modelFrom');
			loadSelect(json.models, 'modelTo');
			//XXX select different model in each 'select' 
		}
		/*if(json.models.length>1) {
			document.getElementById('modelFrom').parentNode.style.display = 'inline-block';
			document.getElementById('modelTo').parentNode.style.display = 'inline-block';
		}*/
		for(var i=0;i<json.models.length;i++) {
			loadSchemas(json.models[i]);
		}
		/*if(json.types) {
			loadSelect(json.types, 'type');
		}*/
	}
});

//TODOne: schemas by model?
loadSchemas = function(model) {
	var url = 'info/schemas.jsp'+(model?'?model='+model:'');
	//console.log('loadSchemas url:', url);
	$.ajax({
		url: url,
		success: function(data) {
			var json = JSON.parse(data);
			//console.log('loadSchemas, schemas',model,json);
			if(json.schemas) {
				schemasByModel[model?model:""] = json.schemas;
				//XXX: merge model's schemas?
				//mergeSelect(json.schemas, 'schema', null, function(data) { return data+' ('+model+')'; } );
				joinSchemas();
			}
		}
	});
}

joinSchemas = function() {
	//console.log('joinSchemas, schemas',Object.keys(schemasByModel).length,document.getElementById(defaultModelId).childElementCount);
	if(Object.keys(schemasByModel).length < document.getElementById(defaultModelId).childElementCount) { return; }
	/*for(var i=0;i<Object.keys(schemasByModel).length;i++) {
		var m = Object.keys(schemasByModel)[i];
		for(var j=0;i<m[i].length;i++) {
			schemas[i] = 
		}
	}*/
	loadModel();
}

loadModel = function() {
	//TODO: merge models...
	var m = document.getElementById(defaultModelId).value;
	//console.log('loadModel, model:', m, defaultModelId, schemasByModel[m], schemasByModel);
	loadSelect(schemasByModel[m], 'schema');
	refreshSelectsState();
	loadObjectList();
}

onModelChanged = function() {
	updateState();
	loadModel();
}

onSchemaChanged = function() {
	updateState();
	loadObjectList();
}

onObjTypeChanged = function() {
	loadObjectList();
}

onObjectChanged = function() {}

loadObjectList = function() {
	var origType = document.getElementById('type').value;
	var type = typemap[origType];
	var model = document.getElementById(defaultModelId).value;
	var schema = document.getElementById('schema').value;
	var url = queryOnUrl+type
		//+ (schema? '/'+schema:'')
		+ '/'+schema
		+ '.json'
		+ (model?'?model='+model:'');
	console.log("loadObjectList: url=",url);
	btnActionStart('object');
	$.ajax({
		//TODO: filter by schema?
		url: url,
		success: function(data) {
			//console.log(data);
			//var jj = JSON.parse(data);
			var keys = Object.keys(data);
			data = getQonData(data);
			//console.log(data);
			//TODOxx filtering data on client, should be on server...
			loadSelect(data, 'object', function(data) { return (data.schemaName?data.schemaName+".":"")+data.name; });
			btnActionStop('object');
		},
		error: function(error) {
			console.log("loadObjectList error=",error);
			btnActionStop('object');
		}
	});
}

getDDL = function(modelId, contentId, contentTitleId, callback) {
	var model = document.getElementById(modelId).value;
	var url = queryOnSchemaUrl+document.getElementById('type').value+'/'
		//+ (document.getElementById('schema').value?document.getElementById('schema').value + '.':'')
		+ document.getElementById('object').value
		+ (model ? '?model='+model : '');
	console.log("getDDL: url=", url, 'modelId=', modelId, 'model=', model);
	$.ajax({
		//TODO: filter by schema?
		url: url,
		success: function(data) {
			//console.log(data);
			var block = document.getElementById(contentId);
			var container = block.parentNode;
			var mblock = document.getElementById(contentId+"-msg");
			var blocktitle = document.getElementById(contentTitleId);
			container.style.display = 'block';
			block.innerHTML = safeTags(data);
			mblock.innerHTML = '';
			mblock.style.display = 'none';
			blocktitle.innerHTML = document.getElementById(modelId).value;
			// http://schier.co/blog/2013/01/07/how-to-re-run-prismjs-on-ajax-content.html
			//Prism.highlightElement(block);
			if(callback) { callback(); }
		},
		error: function(err) {
			//TODO: show error
			console.log('error=',err.status,err);
			var block = document.getElementById(contentId);
			var container = block.parentNode;
			var mblock = document.getElementById(contentId+"-msg");
			//if(err.status==404) {
			//var message = 'Object \''+document.getElementById('object').value+'\' not found on model \''+document.getElementById(modelId).value+'\'';
			mblock.style.display = 'block';
			mblock.innerHTML = '<b>'+document.getElementById(modelId).value+':</b> '+err.responseText;
			//}
			//else {
			//	mblock.style.display = 'none';
			//}
			container.style.display = 'none';
			block.innerHTML = '';
			if(callback) { callback(); }
		}
	});
}

doDiff = function() {
	btnActionStart('go-button');
	doClear();
	getDDL('modelFrom','content-from','content-from-title', doDiffUsingJS);
	getDDL('modelTo','content-to','content-to-title', doDiffUsingJS);
}

doClear = function() {
	var from = document.getElementById('content-from');
	var to = document.getElementById('content-to');
	from.innerHTML = '';
	from.parentNode.style.display = 'none';
	to.innerHTML = '';
	to.parentNode.style.display = 'none';
	document.getElementById('diffoutput').innerHTML = '';
	
	var diffc = document.getElementById('diffoutput-container');
	diffc.style.display = 'none';
	
	var mblock = document.getElementById('content-from-msg');
	mblock.innerHTML = '';
	mblock.style.display = 'none';
	mblock = document.getElementById('content-to-msg');
	mblock.innerHTML = '';
	mblock.style.display = 'none';
	
	document.getElementById('ddldiff-container').style.display = 'none';
	doClearDdlOutput();
}

doClearDdlOutput = function() {
	var block = document.getElementById('ddldiff-output');
	block.innerHTML = '';
	block.style.display = 'none';
	var block = document.getElementById('ddldiff-msg');
	block.innerHTML = '';
	block.style.display = 'none';
	var applyBtn = document.getElementById('applyDdlDiffBtn');
	applyBtn.style.display = 'none';
	applyBtn.value = 'apply DDL diff (?!?)...';
}

doDiffUsingJS = function(viewType) {
	if(viewType === undefined) { viewType = 1; }
	var from = document.getElementById('content-from').innerHTML;
	var to = document.getElementById('content-to').innerHTML;
	var diffc = document.getElementById('diffoutput-container');
	if(from && to
		&& (document.getElementById('modelFrom').value != document.getElementById('modelTo').value)
		) {
		diffc.style.display = 'block';
		diffUsingJS(viewType, from, to,
			document.getElementById('modelFrom').value, document.getElementById('modelTo').value,
			'diffoutput');
		//XXX
		if(document.getElementById('type').value=='TABLE') {
			var ddbtn = document.getElementById('doDataDiffBtn');
			ddbtn.style.display = 'initial';
			ddbtn.href = getDataDiffUrl();
			var ddsbtn = document.getElementById('doDataDiffSqlBtn');
			ddsbtn.style.display = 'initial';
			ddsbtn.href = getDataDiffUrl();
		}
	}
	else {
		diffc.style.display = 'none';
		document.getElementById('diffoutput').innerHTML = "";
		
		document.getElementById('ddldiff-container').style.display = 'block';
		doClearDdlOutput();
		document.getElementById('doDataDiffBtn').style.display = 'none';
		document.getElementById('doDataDiffSqlBtn').style.display = 'none';
	}
	btnActionStop('go-button');
}

diffHasChanges = function(opcodes) {
	for(var i=0;i<opcodes.length;i++) {
		if(opcodes[i][0]!='equal') {
			return true;
		}
	}
	return false;
}

diffUsingJS = function(viewType, from, to, fromTitle, toTitle, outputId) {
	"use strict";
	//console.log("viewType=",viewType);
	var byId = function (id) { return document.getElementById(id); },
		base = difflib.stringAsLines(from),
		newtxt = difflib.stringAsLines(to),
		sm = new difflib.SequenceMatcher(base, newtxt),
		opcodes = sm.get_opcodes(),
		diffoutputdiv = byId(outputId),
		contextSize = 3; //null; //byId("contextSize").value;

	diffoutputdiv.innerHTML = "";
	contextSize = contextSize || null;

	//console.log(base, newtxt);
	diffedLineCount(opcodes);
	
	if(diffHasChanges(opcodes)) {
		diffoutputdiv.appendChild(diffview.buildView({
			baseTextLines: base,
			newTextLines: newtxt,
			opcodes: opcodes,
			baseTextName: fromTitle,
			newTextName: toTitle,
			contextSize: contextSize,
			viewType: viewType
		}));
		byId('togglediffbtn').style.visibility = 'visible';
	}
	else {
		byId('togglediffbtn').style.visibility = 'hidden';
	}
}

diffedLineCount = function(opcodes) {
	//console.log(opcodes); //, fromTitle, toTitle, contextSize, viewType);

	var deleted = 0,
		added = 0,
		chunksReplace = 0,
		chunksInsert = 0,
		chunksDelete = 0;
	for(var i=0;i<opcodes.length;i++) {
		if(opcodes[i][0]=='replace') {
			chunksReplace++;
			deleted += opcodes[i][2]-opcodes[i][1];
			added += opcodes[i][4]-opcodes[i][3];
		}
		if(opcodes[i][0]=='insert') {
			chunksInsert++;
			deleted += opcodes[i][2]-opcodes[i][1];
			added += opcodes[i][4]-opcodes[i][3];
		}
		if(opcodes[i][0]=='delete') {
			chunksDelete++;
			deleted += opcodes[i][2]-opcodes[i][1];
			added += opcodes[i][4]-opcodes[i][3];
		}
	}
	console.log("chunksReplace=", chunksReplace, "chunksInsert=", chunksInsert, "chunksDelete=", chunksDelete,
			"deleted lines=", deleted, "added lines=", added);
	
	var statstext = '';
	if(added > 0) { statstext += '<span class="added" title="'+added+' lines added">'+added+'</span>'; }
	if(deleted > 0) { statstext += '<span class="deleted" title="'+deleted+' lines deleted">'+deleted+'</span>'; }
	if(added == 0 && deleted == 0)  { statstext += '<span class="nochanges">no changes</span>'; }
	
	var stats = document.getElementById('diffstats');
	stats.innerHTML = statstext;
}

toggleDiff = function() {
	var btn = document.getElementById('togglediffbtn');
	if(btn.value=='inline'){
		doDiffUsingJS(0);btn.value='2 pane';
	}else{
		doDiffUsingJS(1);btn.value='inline';
	}
}

getDDLdiff = function(apply) {
	var msg = document.getElementById('ddldiff-msg');
	if(document.getElementById('modelFrom').value == document.getElementById('modelTo').value) {
		console.log("getDDLdiff: same model");
		msg.style.display = 'block';
		msg.innerHTML = 'modelOrig and modelNew must not be the same';
		btnActionStop('getDdlDiffBtn');
		return;
	}
	
	apply = apply==='true'?'true':false;
	// /qdiff/TABLE/<shcema>.<object>?modelFrom=x&modelTo=y
	var url = queryOnDiffUrl+document.getElementById('type').value+'/'
		//+ (document.getElementById('schema').value?document.getElementById('schema').value + '.':'')
		+ document.getElementById('object').value
		+'?modelFrom='+document.getElementById('modelFrom').value
		+'&modelTo='+document.getElementById('modelTo').value
		+(apply?"&doApply=true":"");
	console.log("getDDLdiff: url=", url);
	btnActionStart('getDdlDiffBtn');
	var block = document.getElementById('ddldiff-output');
	block.style.display = 'none';
	msg.style.display = 'none';
	$.ajax({
		//TODO: filter by schema?
		url: url,
		success: function(data) {
			var content = data;
			if(content=='') {
				content = '-- no changes';
			}
			block.innerHTML = safeTags(content);
			block.style.display = 'block';
			var applyBtn = document.getElementById('applyDdlDiffBtn');
			if(data) {
				//TODO: test if user has APPLY permission in type/model/schema (ajax) ...
				applyBtn.style.display = 'initial';
				applyBtn.value = 'apply DDL diff to '+document.getElementById('modelFrom').value;
			}
			btnActionStop('getDdlDiffBtn');
		},
		error: function(error) {
			console.log("loadObjectList error=",error);
			msg.style.display = 'block';
			msg.innerHTML = (apply?"<b>Apply DDL Diff</b>: ":"") + error.responseText;
			btnActionStop('getDdlDiffBtn');
		}
	});
}

getDataDiffUrl = function(syntax) {
	return queryOnDataDiffUrl+document.getElementById('type').value+'/'
	+ document.getElementById('object').value
	+ (syntax?"."+syntax:"")
	+'?modelFrom='+document.getElementById('modelFrom').value
	+'&modelTo='+document.getElementById('modelTo').value
	;
}

doDataDiff = function(syntax) {
	var url = getDataDiffUrl(syntax);
	window.open(url);
}

function updateState() {
	var select = document.getElementById('modelFrom');
	var modelFrom = select.selectedIndex==-1 ? "" : select.options[select.selectedIndex].value;
	var select = document.getElementById('modelTo');
	var modelTo = select.selectedIndex==-1 ? "" : select.options[select.selectedIndex].value;
	var select = document.getElementById('schema');
	var schema = select.options[select.selectedIndex].value;
	if(modelFrom && modelTo && schema) {
		history.replaceState(null, null, "#"+modelFrom+"/"+modelTo+"/"+schema);
	}
}

function refreshSelectsState() {
	var hash = window.location.hash;
	if(hash.indexOf('#')==0) {
		hash = hash.substring(1);
		var parts = hash.split('/');
		var modelFrom = document.getElementById('modelFrom');
		modelFrom.value = parts[0];
		var modelTo = document.getElementById('modelTo');
		modelTo.value = parts[1];
		var schema = document.getElementById('schema');
		schema.value = parts[2];
	}
}


// ----- utility functions

loadSelect = function(data, selectId, callback) {
	if(!callback) { callback = function(obj) { return obj; } }
	var sel = document.getElementById(selectId);
	var prevOptionValue = sel.value;
	$('#'+selectId).empty();
	if(data==null) { console.log('null data; selectId: ',selectId); return; }
	for(var i=0;i<data.length;i++) {
		var name = callback(data[i]);
		if(name==null) { continue; }
		var optionValue = callback(data[i]);
		//console.log('loadSelect:: ',selectId,optionValue,prevOptionValue);
		$('#'+selectId).append("<option value='"+optionValue+"'"+(optionValue==prevOptionValue?" selected":"")+">"+optionValue+"</option>");
	}
}

// see: http://stackoverflow.com/questions/5499078/fastest-method-to-escape-html-tags-as-html-entities
safeTags = function (str) {
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') ;
}

/*mergeSelect = function(data, selectId, idCallback, descCallback) {
	if(!idCallback) { idCallback = function(obj) { return obj; } }
	if(!descCallback) { descCallback = function(obj) { return obj; } }
	//$('#'+selectId).empty();
	for(var i=0;i<data.length;i++) {
		$('#'+selectId).append("<option value='"+idCallback(data[i])+"'>"+descCallback(data[i])+"</option>");
	}
}*/

	</script>
	<style type="text/css">
	#nav {
		background-color: #222;
		color: #ddd;
		font-weight: bold;
		font-size: 10pt;
		padding: 3px;
		padding-bottom: 5px;
		position: fixed;
		top: 0px;
		right: 0px;
		left: 0px;
		/*height: 30px;*/
		z-index: 10;
		overflow-y: auto;
		max-height: 100%;
	}
	#content-container {
		position: relative;
		top: 24px;
	}
	#logo {
		font-size: 11pt;
		font-weight: bolder;
		background-color: #666;
	}
	code {
		display: block;
		unicode-bidi: embed;
		font-family: monospace;
		white-space: pre;
		background-color: whitesmoke;
		overflow-x: scroll;
	}
	.message {
		margin: 10px;
		background-color: #f77;
		padding: 4px;
	}
	textarea.code {
		width: 100%;
		height: 300px;
	}
	
	.code-container {
		width: 48%;
		padding: 4px;
		border: 10px solid #ddd;
	}
	
	.code-container pre {
		margin-top: 0;
	}
	
	.code-title {
		background-color: #fff;
		display: block;
		font-weight: bold;
		padding: 4px;
		border-bottom: 1px solid #ccc;
	}
	.content-elem {
		border: 10px solid #ddd;
	}
	
	#diffoutput {
		font-family: monospace;
		white-space: pre;
		/*clear:both;*/
		border: 10px solid #ddd;
		width: 100%;
	}
	#diffoutput-container {
		display: none;
		clear: both;
	}
	input.content-btn {
		border:1px solid #999;
		background-color: whitesmoke;
	}
	/*a.content-btn {
		border:1px solid #999;
		padding: 3px 9px 3px 9px;
		font-weight: bold;
		text-decoration: none;
		background-color: whitesmoke;
	}*/
	#diffoutput table {
		min-width: 90%;
	}
	
	#diffstats {
		font-family: monospace;
		border: 10px solid #ddd;
	}
	#diffstats span {
		border: 1px solid #aaa;
		padding: 4px 8px 4px 8px;
	}
	#diffstats .added {
		background-color:#9E9;
	}
	#diffstats .deleted {
		background-color:#E99;
	}
	
	#ddldiff-container {
		display: none;
		clear: both;
	}
	#ddldiff-output {
		overflow-x: auto;
		padding: 5px;
		width: 80%;
	}
	#ddldiff-msg {
		width: 80%;
	}
	</style>
</head>
<body>

<div id="nav" class="navbar">
	<span id="logo">Q<span style="color: #ff8a47">On</span> + <span>diff</span></span>

	<label><!--  style="background-color: #A93636"-->
		modelOrig: <select id="modelFrom" onchange="updateState();"></select>
	</label>
	<label style="background-color: #188859">
		modelNew: <select id="modelTo" onchange="onModelChanged();"></select>
	</label>
	<label>
		schema: <select id="schema" onchange="onSchemaChanged();"></select>
	</label>
	<label>
		type: <select id="type" onchange="onObjTypeChanged();"></select>
	</label>
	<label>
		object: <select id="object" onchange="onObjectChanged();"></select>
	</label>
	
	<span id="navbar-prop">
		<input type="button" id="go-button" class="mainaction" value="go!" onclick="doDiff();"/>
		<input type="button" value="clear" onclick="doClear();"/>
	</span>

	<span id="navbar-links">
	</span>
	
	<span id="authinfo">
		<span id="username"></span>
		<span id="authaction"></span>
	</span>
	
	<div id="messages"></div>
</div>

<div style="top: 33px; position: absolute; width: 98%;">

	<div class="code-container" style="float: left;">
		<div id="content-from-msg" class="message" style="display: none;"></div>
		<pre style="display: none;"><span class="code-title" id="content-from-title"></span><code id="content-from" class="language-sql"></code></pre>
	</div>
	<div class="code-container" style="float: right;">
		<div id="content-to-msg" class="message" style="display: none;"></div>
		<pre style="display: none;"><span class="code-title" id="content-to-title"></span><code id="content-to" class="language-sql"></code></pre>
	</div>
	<!-- span style="position:relative; width: 49%; float:left;"><textarea id="content-from" class="code language-sql"></textarea></span>
	<span style="position:relative; width: 49%; float:right;"><textarea id="content-to" class="code language-sql"></textarea></span-->
	
	<div id="diffoutput-container">
		<input id="togglediffbtn" type="button" value="inline" class="content-btn" style="float:right; margin-right: 10px;" onclick="toggleDiff();">
		<div id="diffstats"></div>
		<div id="diffoutput"></div>
	</div>

	<div id="ddldiff-container">
		<div id="ddldiff-controls" class="content-elem">
			<input id="getDdlDiffBtn" class="content-btn" type="button" value="get DDL diff" onclick="getDDLdiff();"/>
			<input id="doDataDiffBtn" class="content-btn external" type="button" style="display: none" value="diff data (html)" onClick="doDataDiff();"/>
			<input id="doDataDiffSqlBtn" class="content-btn external" type="button" style="display: none" value="diff data (sql)" onClick="doDataDiff('sql');"/>
			<input id="applyDdlDiffBtn" class="content-btn" type="button" value="apply DDL diff" onclick="getDDLdiff('true');" style="background-color: rgb(253, 114, 95);"/>
		</div>
		<!-- TODO (if has changes?,) option to call DiffServlet-Apply ... -->
		<div id="ddldiff-msg" class="message" style="display: none;"></div>
		<code id="ddldiff-output" class="language-sql content-elem"></code>
	</div>
</div>


<div id="dialog-container">
	<div id="dialog">
	</div>
</div>

<div id="status-container" class="status">
</div>

</body>
</html>
