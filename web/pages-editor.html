<!DOCTYPE html>
<html>
<head>
	<title>QueryOn - pages editor</title>
	<link href="css/queryon.css" rel="stylesheet">
	<link href="css/qon-editor.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" href="favicon.png" />
	<link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
	<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
	<script type="text/javascript" src="js/jquery.jkey.js"></script>
	<script src="js/qon-base.js"></script>
	<script src="js/qon-util.js"></script>
	<script src="js/auth.js"></script>
	<script src="js/settings.js"></script>
	<script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
// load url: http://<host>/queryon/q/<schema>.QON_PAGES?p1=<id>&valuefield=BODY&mimefield=MIME
//javascript, html, json, markdown, css, xml //XXX add sql?

var extMap = {
	".css": "css",
	".diff": "diff",
	".html": "html",
	".js": "javascript",
	".json": "json",
	".md": "markdown", 
	".markdown": "markdown", 
	".patch": "diff",
	".txt": "plain_text",
	".text": "plain_text",
	".xml": "xml",
	".xsl": "xml"
};
var mimeMap = {
	"html": "text/html",
	"css": "text/css",
	"javascript": "application/javascript",
	"json": "application/json",
	"xml": "application/xml",
	"markdown": "text/markdown",
	"plain_text": "text/plain",
	"diff": "text/plain"
};

var pagesUrl = 'p/';
var qonUrl = 'q/QON_PAGES';
var editor = null;

onLoad = function() {
	var id = getParameterByName('id', location.search);
	
	loadAce();
	loadAuthInfo();
	loadSettings(function() {
		var table = settings['queryon.qon-pages.table'];
		if(table) {
			qonUrl = 'q/'+table;
		}
		console.log("qonUrl: ", qonUrl);
		if(id) {
			byId('id').value = id;
			doLoadPage(id);
		}
		
		updateUI();
	});
}

updateUI = function() {
	var editorDiv = byId('editor');
	var btns = byId('action-btns');
	var nav = byId('nav');
	editorDiv.style.height = (window.innerHeight - btns.offsetHeight - nav.offsetHeight - 7) + 'px';
	if(editor) { editor.resize(); }
}

window.onresize = updateUI;

makeHrefs = function() {
	refreshAuthInfo();
}

function doSaveError(evt) {
	btnActionStop('btnSave');
	console.log('error: ',evt);
	var target = evt.target;
	showErrorMessages('messages', 'error saving page: '+target.responseText+
			(target.status==403?" (invalid session?)":"")
			);
}

function doSave() {
	var id = byId('id').value;
	var path = byId('path').value;
	var mime = byId('mime').value;

	// normalizing path
	path = path.replace(/\/+/g, '\/').replace(/^\//, '');
	//console.log('doSave', byId('path').value, path);
	byId('path').value = path;
	
	//var remarks = byId('remarks').value;
	//var roles = byId('roles').value;

	if(path==null || path=="") {
		showErrorMessages('messages', '<b>path</b> cannot be null...');
		//updateUI();
		return;
	}

	var saveUrl = qonUrl+'?';

	var payload = "v:PATH=" + encodeURIComponent(path) +
		"&v:MIME=" + encodeURIComponent(mime) +
		"&bodyparamname=BODY";
		//"&v:BODY=" + encodeURIComponent( editor.getValue() );
	var messageBody = editor.getValue();
	var method = "POST"; //post: insert ; put: update
	if(id) {
		saveUrl += "p1="+encodeURIComponent(id);
		method = "PUT";
	}
	saveUrl += "&" + payload;
	
	//var payload = new FormData();
	//payload.append('v:ID', id);
	//payload.append('v:PATH', path);
	
	// http://stackoverflow.com/questions/6121203/how-to-do-fade-in-and-fade-out-with-javascript-and-css
	byId('messages').innerHTML = '';
	byId('messages').classList.remove('fadeoutable');
	setTimeout(function() {
		byId('messages').classList.remove('fade');
	}, 10);
	
	var oReq = new XMLHttpRequest();
	oReq.onload = function(evt) {
		var req = evt.target
		var status = req.status;
		if(status>=200 && status<300) {
			btnActionStop('btnSave');
			var pkvals = req.getResponseHeader('X-Relation-UK-Values');
			if(pkvals) {
				byId('id').value = pkvals.trim();
				history.replaceState(null, null, "?id="+byId('id').value);
			}
			console.log('doSave.ok, pkvals=', pkvals, '; evt=', evt);
			//closeMessages('messages');
			byId('messages').classList.remove('fadeoutable');
			setTimeout(function() {
				byId('messages').classList.remove('fade');
				byId('messages').classList.add('fadeoutable');
				showInfoMessages('messages', 'page '+name+' sucessfully saved');
				refreshUI();
				setTimeout(
						function() { byId('messages').classList.add('fade'); },
						2000);
				console.log("fading...");
			}, 10);
		}
		else {
			doSaveError(evt);
		}
	};
	//oReq.addEventListener("error", transferFailed);
	oReq.onerror = doSaveError;
	btnActionStart('btnSave');
	oReq.open(method, saveUrl);
	oReq.send(messageBody);
	//oReq.send(payload);
}

function doLoadPageError(evt) {
	//btnActionStop('btnSave');
	console.log('error: ',evt);
	var target = evt.target;
	showErrorMessages('messages', 'error loading page: '+target.responseText+
			(target.status==403?" (invalid session?)":"")
			);
}

function doLoadPage(id) {
	var loadUrl = qonUrl+'.json';

	var payload = "p1=" + encodeURIComponent(id);
	loadUrl += "?" + payload;
	
	var oReq = new XMLHttpRequest();
	oReq.onload = function(evt) {
		var req = evt.target
		var status = req.status;
		if(status>=200 && status<300) {
			//btnActionStop('btnSave');
			console.log('doLoadPage.ok', evt);
			//showInfoMessages('messages', 'page '+name+' sucessfully loaded');
			var data = getQonData(JSON.parse(req.responseText))[0];
			var PATH = data.PATH || data.path;
			var MIME = data.MIME || data.mime;
			var BODY = data.MIME || data.body;
			//console.log('doLoadPage.ok2', data);
			byId('path').value = PATH;
			if(MIME) {
				byId('mime').value = MIME;
			}
			// http://stackoverflow.com/questions/18614169/set-value-for-ace-editor-without-selecting-the-whole-editor
			editor.setValue(BODY, -1);
			refreshUI();
		}
		else {
			doLoadPageError(evt);
		}
	};
	oReq.onerror = doLoadPageError;
	//btnActionStart('btnSave');
	oReq.open("GET", loadUrl);
	oReq.send(null);
	//oReq.send(payload);
}

function refreshUI() {
	var id = byId('id').value;
	if(id) {
		byId('pages-open').style.display = 'initial';
		var url = (pagesUrl + byId('path').value).replace(/\/+/, '/');
		byId('pages-open').href = url;
	}
	else {
		byId('pages-open').style.display = 'none';
	}
	updateEditorMode();
}

function onPathChange() {
	updateEditorMode();
}

function loadAce() {
	editor = ace.edit("editor");
	editor.$blockScrolling = true;
	editor.setTheme("ace/theme/twilight"); //monokai,ambiance,twilight,,eclipse,github ?
	editor.getSession().setMode("ace/mode/html"); //javascript, html, json, markdown, css, xml
	editor.setOptions({
		fontSize: "11pt"
	});
	/*editor.getSelectedText = function() {
		return this.getSession().getTextRange(this.getSelectionRange());
	};*/
}

updateEditorMode = function() {
	var modeParts = editor.getSession().getMode().$id.split("/");
	var mode = modeParts[modeParts.length-1];
	var path = byId('path').value;
	if(path.endsWith(mode)) { return; }
	
	var keys = Object.keys(extMap);
	for(var i=0;i<keys.length;i++) {
		var type = extMap[keys[i]];
		if(path.endsWith(keys[i])) {
			if(mode!=type) {
				editor.getSession().setMode("ace/mode/"+type);
			}
			byId('mime').value = mimeMap[type];
			return;
		}
	}
	//if not found...
	type = "html";
	if(mode!=type) {
		editor.getSession().setMode("ace/mode/"+type);
	}
	byId('mime').value = mimeMap[type];
}

$(document).jkey('f10',function(){
	console.log('f10 pressed: doSave()');
	doSave();
});

</script>
	<style>
#messages {
	/*border: 1px solid #000;*/
	display: none;
	margin: 2px 4px 0 4px;
	padding: 0 2px 0 4px;
	margin-top: 0;
}
#authinfo {
	float: right;
	margin-top: 2px;
}
	</style>
</head>
<body onload="onLoad();">
<div id="spec">

<nav class="container" id="nav">
	<span id="logo">Q<span style="color: #ff8a47;">On</span> <code>Pages</code></span>
	<label>id: <input type="text" id="id" name="id" size="6" readonly="readonly"/></label>
	<label title="resource URL (known extensions: css, html, javascript, json, markdown, md, xml)">
		path: <input type="text" id="path" name="path" onchange="onPathChange()" size="40"/>
	</label>
	<label>mime: <input type="text" id="mime" name="mime" size="15" readonly="readonly" value="text/html"/></label>
	<label style="display: none">remarks: <input type="text" id="remarks" name="remarks" size="60"/></label>
	<label id="rolesLabel" style="display: none;">
		<span id="rolesLabelText">roles:</span>
		<input type="text" id="roles" name="roles"/>
		<span id="rolesCount" title="# of current allowed roles"></span>
		<input type="button" id="rolesBtn" value="+/- roles" title="Add/Remove roles" onclick="showRolesDialog()"/>
	</label>
	<label id="modelLabel" style="display: none;">model: <input type="text" id="model" name="model" readonly="readonly" value=""/></label>
	
	<span id="xtra-actions">
		<span id="actions-container" style="display: none">
			<a id="url-reload" href="" title="Reload page">reload</a>
			<a id="url-permalink" href="" target="_blank">permalink</a>
			<a id="removebutton" href="#" onclick="if(window.confirm('Do you really want to remove page '+byId('name').value+'?')){doRemove();}" title="Remove Page">remove</a>
		</span>
		<!-- <span id="help"><a href="reader.html#doc/queries.md" title="Editor's help" target="_blank">?</a></span> -->
	</span>

	<span id="authinfo">
		<span id="username"></span>
		<span id="authaction"></span>
	</span>
	
</nav>

<div id="editor" style="width: 100%"></div>

<div class="container" id="action-btns">
	
	<div id="button-container">
		<input type="button" id="btnSave" value="save" onclick="javascript:doSave();" title="Save Page (F10)">
		<a id="pages-open" href="" target="_blank" style="display: none" title="Open in new window"><i class="fa fa-external-link" aria-hidden="true"></i></a>
		<span id="messages"></span>
	</div>
	
</div>

</div>

<div id="rolesListDialogContainer" style="display: none;">
	<div id="rolesListDialog">
		<form id="rolesForm">
		<div id="rolesListDialogContent"></div>
		<div id="rolesListDialogBtns">
			<input type="button" value="change roles" onclick="updateRoles();"/>
			<input type="button" value="close" onclick="closeRolesDialog();"/>
		</div>
		</form>
	</div>
</div>

</body>
