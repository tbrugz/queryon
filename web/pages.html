<!DOCTYPE html>
<html>
<head>
	<title>QueryOn - Pages</title>
	<link href="css/queryon.css" rel="stylesheet">
	<link href="css/qon-components.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" href="favicon.png" />
	<link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
	<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
	<script src="js/qon-base.js"></script>
	<script src="js/qon-util.js"></script>
	<script src="js/auth.js"></script>
	<script src="js/settings.js"></script>
	<script src="js/menu.js"></script>
<script type="text/javascript">

//javascript, html, json, markdown, css, xml
var extMap = {
	".html": "html",
	".css": "css",
	".js": "javascript",
	".json": "json",
	".xml": "xml",
	".md": "markdown", 
	".markdown": "markdown", 
	".txt": "plain_text",
	".text": "plain_text",
	".diff": "diff",
	".patch": "diff"
};
var mimeMap = {
	"html": "text/html",
	"css": "text/css",
	"javascript": "application/javascript",
	"json": "application/json",
	"xml": "application/xml",
	"markdown": "text/markdown",
	"plain_text": "text/plain",
	"diff": "text/plain"
};

var pagesUrl = 'p/';
var qonUrl = 'q/QON_PAGES';
var qonEditorUrl = 'pages-editor.html'

onLoad = function() {
	//var id = getParameterByName('id', location.search);
	
	loadAuthInfo();
	loadSettings(function() {
		var table = settings['queryon.qon-pages.table'];
		if(table) {
			qonUrl = 'q/'+table;
		}
		updateUI();
		loadPagesList();
	});
}

updateUI = function() {
	document.getElementById('content').style.top = document.getElementById('nav').offsetHeight + 'px';
}


window.onresize = updateUI;

makeHrefs = function() {
	refreshAuthInfo();
	byId('url-editor-new').style.display = authInfo.isDev?'inline':'none';
	byId('url-upload').style.display = authInfo.isDev?'inline':'none';
}

loadPagesList = function() {
	var loadUrl = qonUrl+'.json';

	var payload = "fields=ID,PATH,MIME&order=PATH";
	loadUrl += "?" + payload;
	
	var oReq = new XMLHttpRequest();
	oReq.onload = function(evt) {
		var req = evt.target
		var status = req.status;
		if(status>=200 && status<300) {
			var content = byId('content');
			
			var pages = getQonData(JSON.parse(req.responseText));
			for(var i=0;i<pages.length;i++) {
				content.innerHTML += "\n<li id='p"+pages[i].ID+"'><a href='p/"+pages[i].PATH+"' target='_blank' class='ref'>"+pages[i].PATH+"</a> "+
					(pages[i].MIME=="text/markdown"?" <a href='md/"+pages[i].PATH+"' target='_blank' class='ref'>[as html]</a>":"")+
					(authInfo.isDev?" <a href='pages-editor.html?id="+pages[i].ID+"' target='_blank'>[edit]</a>":"")+
					(authInfo.isDev?" <a href='#' onclick='removePage("+pages[i].ID+", \""+pages[i].PATH+"\");false;'>[remove]</a>":"")+
					//XXX add delete button
					"</li><br/>";
			}
		}
		else {
			console.warn(evt);
		}
	};
	oReq.onerror = function(evt) {
		console.warn(evt);
	}
	oReq.open("GET", loadUrl);
	oReq.send(null);
}

removePage = function(id, path) {
	if(confirm("remove page "+path+"?")) {
		var loadUrl = qonUrl+'/'+id+'.json';
		
		var request = new XMLHttpRequest();
		request.open("DELETE", loadUrl, true);
		request.onload = function(oEvent) {
			var msg = null;
			if (request.status >= 200 && request.status < 300) {
				msg = "Resource "+path+" deleted";
				//alert(msg);
				byId("p"+id).classList.add("removed");
			} else {
				msg = "Error " + request.status + " occurred when trying to delete resource \""+path+"\":\n"+
					oEvent.target.responseText.trim();
				alert(msg);
			}
			console.log(msg, oEvent);
		};
		//console.log('FormData: ', fd, ' - formElement', formElement);
		request.send();
	}
}

openUploadDialog = function() {
	var dialogCont = document.getElementById('dialog-container');
	dialogCont.style.display = 'block';
	
	var dialog = byId('update-dialog');
	dialog.style.display = 'block';
	
	var dialogHTML = '<div id="dialog-header">'
		+ '<div class="dialog-title">Upload binary data</div>'
		+ "<div id='dialog-messages'></div></div>";
	dialogHTML += "<div><form name='upload-form' id='upload-form' enctype='multipart/form-data' method='post' >";
	dialogHTML += "<label>path: <input type='text' name='v:PATH'/>"+" <span class='remarks'>resource path</span>"+"</label> ";
	dialogHTML += "<label>file: <input type='file' name='v:BINARY_DATA'/>"+" <span class='remarks'>binary content</span>"+"</label> ";
	dialogHTML += "</form></div> ";

	dialog.innerHTML = dialogHTML + "<div id='dialog-footer'>"
		+ "<input type='button' value='upload' id='btnUpdate' class='simplebutton' onclick='doConfirmUpload();'/>"
		//+ "<input type='button' value='upload & close' class='simplebutton' onclick='doConfirmUpload(true);'/>"
		+ "<input type='button' value='X' class='simplebutton' onclick='closeUploadDialog();'/>"
		+ "</div>";
}

closeUploadDialog = function() {
	var dialogCont = document.getElementById('dialog-container');
	dialogCont.style.display = 'none';
	closeMessages("update-dialog");
}

doConfirmUpload = function() {
	var loadUrl = qonUrl+'.json';
	
	var formElement = document.querySelector("#upload-form");
	var request = new XMLHttpRequest();
	var fd = new FormData(formElement);
	if(! fd.get('v:PATH')) {
		showWarnMessages('dialog-messages', "path cannot be null");
		return;
	}
	request.open("POST", loadUrl, true);
	request.onload = function(oEvent) {
		var msg = null;
		if (request.status >= 200 && request.status < 300) {
			msg = "Uploaded!";
			showInfoMessages('dialog-messages', msg)
		} else {
			msg = "Error " + request.status + " occurred when trying to upload your file: "+oEvent.target.responseText.trim();
			showErrorMessages('dialog-messages', msg)
		}
		console.log(msg, oEvent);
	};
	console.log('FormData: ', fd, ' - formElement', formElement);
	request.send(fd);
}

</script>
<style>
#messages {
	border: 1px solid #000;
	display: none;
	margin: 2px 4px 0 4px;
	padding: 2px;
}

#content {
	padding: 20px;
}

#content li {
	list-style-type: none;
}

#content a, #content a:visited {
	color: #000;
	font-size: 11pt;
	padding: 4px
}

li.removed {
	background-color: #f99;
	text-decoration: line-through;
}

#dialog-messages {
	padding: 3px;
	display: none;
}
/*#dialog-messages span {
	padding-left: 4px;
}*/

#content a.ref {
	background-color: #fff;
}

.remarks {
	font-style: italic;
}

input[type="file"] {
	background-color: #ccc;
}

</style>
</head>
<body onload="onLoad();">

<nav class="navbar" id="nav">
	<span id="logo">Q<span style="color: #ff8a47;">On</span> <code>Pages</code></span>

	<span id="navbar-links">
		<span id="navbar-actions">
			<a id="url-editor-new" class="edit-link" href="" target="_blank" style="display: none">new</a> <a id="url-upload" class="edit-link" href="#" onclick="openUploadDialog();false;" style="display: none">upload</a>
		</span>
	</span>

	<!-- <label id="modelLabel" style="display: none;">model: <input type="text" id="model" name="model" readonly="readonly" value=""/></label> -->
	<!-- <span id="help"><a href="reader.html#doc/queries.md" title="Editor's help" target="_blank">?</a></span> -->

	<span id="authinfo">
		<span id="username"></span>
		<span id="authaction"></span>
	</span>

	<div id="messages"></div>
</nav>

<div id="content" class="container"></div>

<div id="dialog-container">
	<div id="update-dialog"></div>
</div>

</body>
