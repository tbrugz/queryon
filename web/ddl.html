<!DOCTYPE html>
<html>
<head>
	<title>QueryOn</title>
	<link href="css/queryon.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" type="image/png" href="favicon.png" />
	<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
	<script>
	var queryOnUrl = 'q/';
	var queryOnSchemaUrl = 'qos/';

typemap = {
		"TABLE": "table",
		"FK": "fk",
		"VIEW": "view",
		"INDEX": null,
		"EXECUTABLE": null,
		"TRIGGER": "executable",
		"SEQUENCE": null,
		"SYNONYM": null,
		"GRANT": null,
		"MATERIALIZED_VIEW": "view",
		"FUNCTION": "executable",
		"JAVA_SOURCE": null,
		"PACKAGE": "executable",
		"PACKAGE_BODY": "executable",
		"PROCEDURE": "executable",
		"TYPE": "executable",
		"TYPE_BODY": "executable",
		"CONSTRAINT": null,
		"COLUMN": null
};

$(document).ready(
	function() {
		var tts = [];
		var keys = Object.keys(typemap);
		//console.log(keys.length);
		for(var i=0;i<keys.length;i++) {
			if(typemap[keys[i]]) { tts.push(keys[i]); }
		}
		loadSelect(tts, 'type');
	}
);

$.ajax({
	url: 'info/model.jsp',
	success: function(data) {
		var json = JSON.parse(data);
		//console.log(json);
		if(json.models) {
			loadSelect(json.models, 'model');
		}
		/*if(json.types) {
			loadSelect(json.types, 'type');
		}*/
	}
});

//TODO: schemas by model?
$.ajax({
	url: 'info/schemas.jsp',
	success: function(data) {
		var json = JSON.parse(data);
		//console.log(json);
		if(json.schemas) {
			loadSelect(json.schemas, 'schema');
		}
	}
});

onModelChanged = function() {
	loadObjectList();
}

onSchemaChanged = function() {
	//loadObjectList();
}

onObjTypeChanged = function() {
	loadObjectList();
}

onObjectChanged = function() {}

loadObjectList = function() {
	var type = typemap[document.getElementById('type').value];
	var url = queryOnUrl+type+'.json?model='+document.getElementById('model').value;
	console.log("loadObjectList: url=",url);
	$.ajax({
		//TODO: filter by schema?
		url: url,
		success: function(data) {
			//console.log(data);
			//var jj = JSON.parse(data);
			var keys = Object.keys(data);
			data = data[Object.keys(data)[0]];
			//console.log(data);
			loadSelect(data, 'object', function(data) { return (data.schemaName?data.schemaName+".":"")+data.name; });
		}
	});
}

getDDL = function() {
	var url = queryOnSchemaUrl+document.getElementById('type').value+'/'
		//+ (document.getElementById('schema').value?document.getElementById('schema').value + '.':'')
		+ document.getElementById('object').value
		+'?model='+document.getElementById('model').value;
	console.log("getDDL: url=", url);
	$.ajax({
		//TODO: filter by schema?
		url: url,
		success: function(data) {
			//console.log(data);
			document.getElementById('content').innerHTML = data;
			document.getElementById('content').style.display = 'block';
		},
		error: function() {
			//TODO: show error
			document.getElementById('content').style.display = 'none';
		}
	});
}

// ----- utility functions

loadSelect = function(data, selectId, callback) {
	if(!callback) { callback = function(obj) { return obj; } }
	$('#'+selectId).empty();
	for(var i=0;i<data.length;i++) {
		$('#'+selectId).append("<option value='"+callback(data[i])+"'>"+callback(data[i])+"</option>");
	}
}

	</script>
	<style type="text/css">
	#nav {
		background-color: #222;
		color: #ddd;
		font-weight: bold;
		font-size: 10pt;
		padding: 3px;
		padding-bottom: 5px;
		position: fixed;
		top: 0px;
		right: 0px;
		left: 0px;
		/*height: 30px;*/
		z-index: 10;
		overflow-y: auto;
		max-height: 100%;
	}
	#content-container {
		position: relative;
		top: 34px;
	}
	#logo {
		font-size: 11pt;
		font-weight: bolder;
		background-color: #666;
	}
	#content {
		display: block;
		unicode-bidi: embed;
		font-family: monospace;
		white-space: pre;
		padding: 4px;
		border: 10px solid #ddd;
		background-color: whitesmoke;
	}
	</style>
</head>
<body>

<div id="nav" class="navbar">
	<span id="logo">Q<span style="color: #ff8a47">On</span> + <span>DDL</span></span>

	<label>
		model: <select id="model" onchange="onModelChanged();"></select>
	</label>
	<label style="display: none">
		schema: <select id="schema" onchange="onSchemaChanged();"></select>
	</label>
	<label>
		type: <select id="type" onchange="onObjTypeChanged();"></select>
	</label>
	<label>
		object: <select id="object" onchange="onObjectChanged();"></select>
	</label>
	
	<span id="navbar-prop">
		<input type="button" id="go-button" class="mainaction" value="go!" onclick="getDDL();"/>
	</span>

	<span id="navbar-links">
	</span>
	
	<span id="authinfo">
		<span id="username"></span>
		<span id="authaction"></span>
	</span>
	
	<div id="messages"></div>
</div>

<div id="content-container">
	<div id="content" style="display: none;">
	</div>
</div>

<div id="dialog-container">
	<div id="dialog">
	</div>
</div>

<div id="status-container" class="status">
</div>

</body>
</html>
